<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>[ANSWER] preload / preconnect / prefetch로 LCP 앞당기기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 1) 이미지 CDN과 미리 연결 (DNS/TCP/TLS 선행) -->
  <link rel="preconnect" href="https://via.placeholder.com" crossorigin>

  <!-- ✅ 2) LCP 후보 이미지 미리 받아두기 (as는 반드시 image) -->
<link rel="preload"
      as="image"
      href="https://picsum.photos/1600/900?random=1"
      imagesrcset="https://picsum.photos/1200/675?random=2 1200w,
                   https://picsum.photos/1600/900?random=1 1600w"
      imagesizes="(max-width: 1200px) 92vw, 1200px">


  <!-- ✅ 3) 다음 섹션(지금은 불필요) 리소스는 미리 다운로드(우선순위 낮게) -->
  <link rel="prefetch" href="./assets/next-section.bundle.js" as="script">
<link rel="prefetch" href="https://picsum.photos/1200/800?random=3" as="image">

  <style>
    body{margin:0;font-family:system-ui,sans-serif}
    .hero{min-height:100vh;display:grid;place-items:center;text-align:center;padding:24px}
    .hero img{max-width:min(92vw, 1200px);width:100%;height:auto;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15)}
    .title{font-size:clamp(24px,6vw,42px);margin:16px 0 8px}
    .sub{color:#64748b;margin:0 0 16px}
    .next{padding:56px 24px;border-top:1px solid #e2e8f0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:16px}
    .card{border:1px solid #e2e8f0;border-radius:10px;padding:16px}
    .muted{color:#64748b}
    .next img{max-width:100%;height:auto;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.12)}
  </style>
</head>
<body>
  <section class="hero">
    <div>
      <!-- 같은 URL이어야 preload 응답 재사용(중복 다운 방지) -->
<img
  src="https://picsum.photos/1600/900?random=1"
  srcset="https://picsum.photos/1200/675?random=2 1200w,
          https://picsum.photos/1600/900?random=1 1600w"
  sizes="(max-width: 1200px) 92vw, 1200px"
  alt="히어로 이미지 (LCP 후보)">
      <h1 class="title">LCP를 앞당겼습니다</h1>
      <p class="sub">preconnect + preload로 이미지 요청을 더 일찍 시작</p>
    </div>
  </section>

  <section class="next" id="next">
    <h2>다음 섹션</h2>
    <p class="muted">prefetch로 미리 받아둔 자원을 스크롤 진입 시 즉시 사용합니다.</p>
    <div id="next-placeholder" style="height:280px;display:grid;place-items:center;color:#64748b;border:1px dashed #cbd5e1;border-radius:8px;">
      (스크롤 진입 시 기능 활성화)
    </div>
    <div id="next-content" hidden>
      <div class="grid" id="grid"></div>
      <figure style="margin-top:16px">
        <img id="next-img" alt="다음 섹션 이미지 (prefetch)">
        <figcaption class="muted">prefetch로 미리 받은 이미지를 즉시 표시</figcaption>
      </figure>
    </div>
  </section>

  <script>
    // (선택) LCP 콘솔 로거
    try{
      new PerformanceObserver((list)=>{
        const entry = list.getEntries().at(-1);
        if(entry){ console.log('[ANSWER] LCP', Math.round(entry.startTime),'ms', entry); }
      }).observe({type:'largest-contentful-paint', buffered:true});
    }catch(e){}

    // ✅ IntersectionObserver: 다음 섹션이 뷰포트 근처(200px) 진입 시, 사전 가져온 번들을 "동일 URL"로 실행
    (function activateNextSection(){
      const target = document.getElementById('next');
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            io.disconnect();
            // 동일 URL로 script를 주입 → prefetch 캐시를 재사용해 즉시 실행 기대
            const s = document.createElement('script');
            s.src = './assets/next-section.bundle.js';
            s.onload = ()=> console.log('[ANSWER] next-section.bundle 실행 완료 (prefetch 캐시 활용)');
            document.head.appendChild(s);
          }
        });
      }, { root:null, rootMargin:'200px 0px', threshold:0.01 });
      io.observe(target);
    })();
  </script>
</body>
</html>
